#!/bin/sh
#
# $FreeBSD$
#

# PROVIDE: ix-avahi
# BEFORE: avahi_daemon

. /etc/rc.subr

multi_service="/usr/local/etc/avahi/services/multi.service"

generate_config()
{

afp=$(${LIBREBSD_SQLITE_CMD} ${LIBREBSD_CONFIG} "SELECT srv_enable FROM services_services WHERE srv_service = 'afp'")
cifs=$(${LIBREBSD_SQLITE_CMD} ${LIBREBSD_CONFIG} "SELECT srv_enable FROM services_services WHERE srv_service = 'cifs'")
nfs=$(${LIBREBSD_SQLITE_CMD} ${LIBREBSD_CONFIG} "SELECT srv_enable FROM services_services WHERE srv_service = 'nfs'")
ssh=$(${LIBREBSD_SQLITE_CMD} ${LIBREBSD_CONFIG} "SELECT srv_enable FROM services_services WHERE srv_service = 'ssh'")
ftp=$(${LIBREBSD_SQLITE_CMD} ${LIBREBSD_CONFIG} "SELECT srv_enable FROM services_services WHERE srv_service = 'ftp'")
ftpport=$(${LIBREBSD_SQLITE_CMD} ${LIBREBSD_CONFIG} "SELECT ftp_port FROM services_ftp ORDER BY -id LIMIT 1")
rsync=$(${LIBREBSD_SQLITE_CMD} ${LIBREBSD_CONFIG} "SELECT srv_enable FROM services_services WHERE srv_service = 'rsync'")
rsyncport=$(${LIBREBSD_SQLITE_CMD} ${LIBREBSD_CONFIG} "SELECT rsyncd_port FROM services_rsyncd ORDER BY -id LIMIT 1")
web=$(${LIBREBSD_SQLITE_CMD} ${LIBREBSD_CONFIG} "SELECT stg_guiprotocol FROM system_settings ORDER BY -id LIMIT 1")
http=$(${LIBREBSD_SQLITE_CMD} ${LIBREBSD_CONFIG} "SELECT stg_guiport FROM system_settings ORDER BY -id LIMIT 1")
if [ -z ${http} ]; then
	http="80"
fi

https=$(${LIBREBSD_SQLITE_CMD} ${LIBREBSD_CONFIG} "SELECT stg_guihttpsport FROM system_settings ORDER BY -id LIMIT 1")
if [ -z ${https} ]; then
	https="443"
fi

cat > "$multi_service" <<EOF
<?xml version="1.0" standalone="no"?>
<!DOCTYPE service-group SYSTEM "avahi-service.dtd">
<service-group>
  <name replace-wildcards="yes">%h</name>
  <service>
    <type>_device-info._tcp</type>
    <port>0</port>
    <txt-record>model=RackMac</txt-record>
  </service>
EOF

if [ $afp -eq 1 ]; then
    cat >> "$multi_service" <<EOF
  <service>
    <type>_afpovertcp._tcp</type>
    <port>548</port>
  </service>
EOF
fi

if [ $cifs -eq 1 ]; then
    cat >> "$multi_service" <<EOF
  <service>
      <type>_smb._tcp</type>
      <port>445</port>
  </service>
EOF
fi

if [ $nfs -eq 1 ]; then
    cat >> "$multi_service" <<EOF
  <service>
    <type>_nfs._tcp</type>
    <port>2049</port>
EOF
    ${LIBREBSD_SQLITE_CMD} ${LIBREBSD_CONFIG} "SELECT path FROM sharing_nfs_share_path" | \
        while read -r path; do
            echo "    <txt-record>path=${path}</txt-record>" >> "$multi_service"
    	done
    echo "  </service>" >> "$multi_service"
fi

if [ $ssh -eq 1 ]; then
    cat >> "$multi_service" <<EOF
  <service>
    <type>_sftp-ssh._tcp</type>
    <port>22</port>
  </service>
  <service>
    <type>_ssh._tcp</type>
    <port>22</port>
  </service>
EOF
fi

if [ $web = "http" ]; then
    cat >> "$multi_service" <<EOF
  <service>
    <type>_http._tcp</type>
    <port>${http}</port>
  </service>
EOF
fi

if [ $web = "https" ]; then
    cat >> "$multi_service" <<EOF
  <service>
    <type>_https._tcp</type>
    <port>${https}</port>
  </service>
EOF
fi

if [ $web = "httphttps" ]; then
    cat >> "$multi_service" <<EOF
  <service>
    <type>_http._tcp</type>
    <port>${http}</port>
  </service>
  <service>
    <type>_https._tcp</type>
    <port>${https}</port>
  </service>
EOF
fi

if [ $ftp -eq 1 ]; then
    cat >> "$multi_service" <<EOF
  <service>
    <type>_ftp._tcp</type>
    <port>${ftpport}</port>
  </service>
EOF
fi

if [ $rsync -eq 1 ]; then
    cat >> "$multi_service" <<EOF
  <service>
    <type>_rsync._tcp</type>
    <port>${rsyncport}</port>
  </service>
EOF
fi

cat >> "$multi_service" <<EOF
</service-group>
EOF

}

name="ix_avahi"
start_cmd='generate_config'
stop_cmd=':'

load_rc_config $name
run_rc_command "$1"
